# ML Fraud Detection Service

**DISCLAIMER**

Сервис подготовлен в демонстрационных целях в рамках занятий по MLOps.
Датасеты предоставлены в рамках соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025).

Сервис для автоматического обнаружения мошеннических транзакций в режиме батчевого скоринга. Обрабатывает CSV-файлы из указанной директории с использованием предобученной CatBoost модели. Результаты сохраняются в файле `sample_submission.csv`.

## Архитектура решения
```
ml_service/
├── input/                     # Директория для входных файлов (test.csv)
├── output/                    # Директория для выходных файлов
├── app/(app.py)               # Скрипт с логикой всего приложения
├── src/                       # Исходный код сервиса
│   ├── preprocess.py          # Скрипт для препроцессинга данных
│   ├── scorer.py              # Скрипт для инференса модели
│   ├── feature_importance.py  # Скрипт для выгрузки важности признаков
│   └── plot_predictions.py    # Скрипт для построения графика плотности предсказаний
├── model/                     # Модель CatBoost и порог
│   ├── catboost_model.cbm     # Сохраненная модель
│   └── threshold.json         # Порог классификации
├── train_data/(train.csv)     # train датасет для энкодинга
├── config.yaml                # Конфигурационный файл
├── requirements.txt           # Зависимости Python
├── Dockerfile                 # Файл для сборки Docker-образа
├── .dockerignore              # Файл для исключения ненужных файлов
└── README.md                  # Инструкция по использованию сервиса
```

## Ключевые особенности

### Многоуровневое логирование
- Регистрация всех событий в файл `/app/logs/service.log`
- Консольный вывод для мониторинга в реальном времени
- 3 уровня детализации:
  - `INFO`: Основные этапы обработки
  - `DEBUG`: Детали преобразования данных
  - `ERROR`: Критические сбои с трейсбэками

### Пайплайн обработки данных (`preprocessing.py`)
1. **Временные признаки**:
   - Извлечение часа, года, месяца, дня месяца, дня недели
   - Удаление исходного timestamp
   
2. **Геопространственные расчеты**:
   - Расчет расстояния (км) между клиентом и мерчантом
   - Использование формулы гаверсинусов

3. **Категориальные переменные**:
   - Группировка редких категорий (N+1 кодирование)
   - Mean-encoding с учетом целевой переменной

4. **Числовые признаки**:
   - Импутация средними значениями
   - Логарифмирование с добавлением эпсилон-коррекции

### Модельный слой (`scorer.py`)
- Порог классификации: загружается из файла `threshold.json`
- Автоматическая загрузка модели при инициализации
- Батчевая обработка через `predict_proba`

## Быстрый старт

### Требования
- Docker 20.10+
- 2 ГБ свободного места
- Порты: только файловая система

### Запуск сервиса

1. **Скачайте файл `train.csv`** из соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025) и разместите его в директории `./train_data`.
2. **Склонируйте репозиторий**:
   ```bash
   git clone https://github.com/yourusername/ml_service.git
   cd ml_service
   ```
3. **Соберите образ**:
   ```bash
   docker build -t fraud_detector .
   ```
4. **Запустите контейнер с монтированием томов**:
   ```bash
   docker run -it --rm -v ./input:/app/input \
                    -v ./output:/app/output \
                    fraud_detector
   ```
5. **После запуска сервиса** (появления в логах сообщения: `__main__ - INFO - Наблюдатель за файлами запущен`) можно приступать к скорингу данных:
   - Разместите файл формата `test.csv` из соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025) в директории `./input`.
   - Подождите выполнения препроцессинга и скоринга датасета (в логах будет указано название сформированного файла).
   - Полученный результат моделирования будет выгружен сервисом в директорию `./output`.
   - Получите файл `sample_submission.csv` в директории `./output`.
   - Получите файл `feature_importance.json` и график `density_plot.png` в директории `./output`.


### Просмотр логов
Логи сервиса сохраняются в файле `/app/logs/service.log` внутри контейнера. Вы можете просматривать их, используя команду `docker logs` или монтируя директорию логов на хост-систему.

**Пример просмотра логов:**
```bash
docker logs <container_id>
```

**Монтирование директории логов:**
```bash
docker run -it --rm -v ./input:/app/input \
                    -v ./output:/app/output \
                    -v ./logs:/app/logs \
                    fraud_detector
```

### Зависимости
Смотрите `requirements.txt`.


### Лицензия
MIT License

